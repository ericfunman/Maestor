name: Maestror CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  backend-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      working-directory: ./backend
      run: mvn clean install -DskipTests
    
    - name: Run Tests
      working-directory: ./backend
      run: mvn test
    
    - name: Generate JaCoCo Report
      working-directory: ./backend
      run: mvn jacoco:report
    
    - name: SonarCloud Scan
      working-directory: ./backend
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mvn sonar:sonar \
          -Dsonar.projectKey=ericfunman_Maestor \
          -Dsonar.organization=ericfunman \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=$SONAR_TOKEN
    
    - name: Build Docker Image
      working-directory: ./backend
      run: |
        docker build -t maestror-backend:${{ github.sha }} .
        docker tag maestror-backend:${{ github.sha }} maestror-backend:latest

  frontend-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Install Dependencies
      working-directory: ./frontend
      run: npm install
    
    - name: Build
      working-directory: ./frontend
      run: npm run build
    
    - name: Build Docker Image
      working-directory: ./frontend
      run: |
        docker build -t maestror-frontend:${{ github.sha }} .
        docker tag maestror-frontend:${{ github.sha }} maestror-frontend:latest

  deploy:
    needs: [backend-build, frontend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Cloud
      run: |
        echo "Deployment step - configure based on target platform"
        # Add deployment commands here (Azure, AWS, GCP, etc.)
